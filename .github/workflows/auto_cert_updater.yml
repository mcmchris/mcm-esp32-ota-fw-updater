name: Actualizador Autom치tico de Certificados

on:
  schedule:
    - cron: '0 8 * * 1' # Ejecutar todos los lunes a las 8 AM (o diario si prefieres)
  workflow_dispatch:    # Bot칩n manual para forzar la actualizaci칩n

jobs:
  update-certs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout del c칩digo
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Instalar dependencias del script
        run: |
          pip install click pyopenssl certifi

      - name: Descargar herramienta (pycert_bearssl + dependencias)
        run: |
          # Descargamos el script oficial de la librer칤a SSLClient
          wget https://raw.githubusercontent.com/OPEnSLab-OSU/SSLClient/master/tools/pycert_bearssl/pycert_bearssl.py
          wget https://raw.githubusercontent.com/OPEnSLab-OSU/SSLClient/master/tools/pycert_bearssl/cert_util.py

      - name: Generar nuevos certificados (MCM_CertStore.h)
        run: |
          echo "Generando Trust Anchors para GitHub y AWS (S3)..."
          
          # Ejecutamos el script contra los dominios cr칤ticos:
          # 1. api.github.com -> Para la API REST
          
          python3 pycert_bearssl.py download \
            api.github.com \
            github.com \
            codeload.github.com \
            --output MCM_CertStore.h
          
          rm pycert_bearssl.py cert_util.py
          rm -rf __pycache__
            
          # Movemos el archivo generado a la ubicaci칩n correcta (ajusta si tu .h est치 en una carpeta 'src' o 'include')
          # mv MCM_CertStore.h src/MCM_CertStore.h  <-- DESCOMENTAR Y AJUSTAR SI ES NECESARIO

      - name: Verificar cambios
        id: verify_diff
        run: |
          git diff MCM_CertStore.h
          # Si no hay cambios, el paso siguiente no crear치 PR

      - name: Crear Pull Request con los nuevos certificados
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "security: Actualizaci칩n autom치tica de Certificados SSL"
          title: "游댏 Actualizaci칩n de Certificados SSL (MCM_CertStore.h)"
          body: |
            Este PR fue generado autom치ticamente por GitHub Actions.
            
            Se han detectado cambios en la cadena de certificaci칩n de GitHub.
            El archivo `MCM_CertStore.h` ha sido regenerado con los Trust Anchors vigentes hoy.
            
            **Pasos para el humano:**
            1. Revisa los cambios en el archivo.
            2. Si todo parece correcto (ves DigiCert, Sectigo, etc.), haz Merge.
            3. El sistema compilar치 el nuevo firmware autom치ticamente (si tienes CI de compilaci칩n).
          branch: update-ssl-certs
          base: main
          delete-branch: true

          add-paths: |
            MCM_CertStore.h