name: Actualizador Automático de Certificados

on:
  schedule:
    - cron: '0 8 * * 1' # Ejecutar todos los lunes a las 8 AM (o diario si prefieres)
  workflow_dispatch:    # Botón manual para forzar la actualización

jobs:
  update-certs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Instalar dependencias
        run: |
          sudo apt-get update
          pip install click pyopenssl certifi

      - name: Descargar herramientas BearSSL
        run: |
          wget https://raw.githubusercontent.com/OPEnSLab-OSU/SSLClient/master/tools/pycert_bearssl/pycert_bearssl.py
          wget https://raw.githubusercontent.com/OPEnSLab-OSU/SSLClient/master/tools/pycert_bearssl/cert_util.py

      - name: Descargar y Normalizar Certificados
        run: |
          # Función para descargar y convertir a PEM sea cual sea el origen
          normalize_cert() {
              local filename=$1
              local url=$2
              echo "⬇️ Procesando $filename..."
              
              # 1. Descargar
              wget -q -O temp.blob "$url"
              
              # 2. Intentar convertir (Lógica Inteligente)
              # Primero probamos si ya es PEM (Texto estándar)
              if openssl x509 -in temp.blob -out "$filename.pem"; then
                  echo "   ✅ Detectado formato PEM nativo."
              # Si falla, probamos si es DER (Binario) y lo convertimos
              elif openssl x509 -inform DER -in temp.blob -out "$filename.pem"; then
                  echo "   ✅ Detectado formato DER. Convertido a PEM."
              else
                  echo "   ❌ ERROR: No se pudo reconocer el formato del certificado."
                  exit 1
              fi
              rm temp.blob
          }

          echo "--- INICIANDO DESCARGA DE RAÍCES ---"

          # 1. USERTrust ECC Certification Authority (GitHub API) - ID 2841410
          normalize_cert "usertrust_ecc" "https://crt.sh/?d=2841410"

          # 2. AAA Certificate Services (GitHub CDN Legacy) - ID 331986
          normalize_cert "aaa_services" "https://crt.sh/?d=331986"

          # 3. Starfield Class 2 Certification Authority (AWS S3 Legacy) - ID 1063596
          normalize_cert "starfield_class2" "https://crt.sh/?d=1063596"

      - name: Generar MCM_CertStore.h
        run: |
          echo "Generando archivo de cabecera C++..."
          
          # Usamos 'convert' con los archivos .pem ya saneados
          python3 pycert_bearssl.py convert \
            usertrust_ecc.pem \
            aaa_services.pem \
            starfield_class2.pem \
            --output MCM_CertStore.h
            
          # LIMPIEZA
          rm *.pem *.py
          rm -rf __pycache__

      - name: Verificar cambios
        id: verify_diff
        run: |
          git diff MCM_CertStore.h