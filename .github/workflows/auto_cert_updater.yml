name: Actualizador Automático de Certificados

on:
  schedule:
    - cron: '0 8 * * 1' # Ejecutar todos los lunes a las 8 AM (o diario si prefieres)
  workflow_dispatch:    # Botón manual para forzar la actualización

jobs:
  update-certs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Instalar dependencias
        run: |
          sudo apt-get update
          pip install click pyopenssl certifi

      - name: Descargar herramientas BearSSL
        run: |
          wget https://raw.githubusercontent.com/OPEnSLab-OSU/SSLClient/master/tools/pycert_bearssl/pycert_bearssl.py
          wget https://raw.githubusercontent.com/OPEnSLab-OSU/SSLClient/master/tools/pycert_bearssl/cert_util.py

      - name: Descargar y Preparar Certificados Raíz
        run: |
          echo "Descargando las 3 Raíces exactas que usa el Web Tool..."

          # 1. USERTrust ECC Certification Authority (Para api.github.com)
          # ID crt.sh: 2841410
          wget -O usertrust_ecc.der "https://crt.sh/?d=2841410"

          # 2. AAA Certificate Services (Para CDN GitHub / Sectigo Legacy)
          # ID crt.sh: 331986
          wget -O aaa_services.der "https://crt.sh/?d=331986"

          # 3. Starfield Class 2 Certification Authority (Para AWS S3 Legacy)
          # ID crt.sh: 1063596
          wget -O starfield_class2.der "https://crt.sh/?d=1063596"

          echo "Convirtiendo de Binario (DER) a Texto (PEM)..."
          # Este paso es CRUCIAL. El script de Python falla si le das DER.
          # Debemos convertirlos a PEM usando OpenSSL.
          
          openssl x509 -inform DER -in usertrust_ecc.der -out usertrust_ecc.pem
          openssl x509 -inform DER -in aaa_services.der -out aaa_services.pem
          openssl x509 -inform DER -in starfield_class2.der -out starfield_class2.pem

      - name: Generar MCM_CertStore.h
        run: |
          echo "Generando archivo de cabecera con 3 TAs..."
          
          # Usamos 'convert' para procesar los archivos locales ya preparados.
          # Esto garantiza el resultado exacto sin depender de la red o el OS.
          
          python3 pycert_bearssl.py convert \
            usertrust_ecc.pem \
            aaa_services.pem \
            starfield_class2.pem \
            --output MCM_CertStore.h
            
          # LIMPIEZA
          rm *.der *.pem *.py
          rm -rf __pycache__

      - name: Verificar cambios
        id: verify_diff
        run: |
          git diff MCM_CertStore.h