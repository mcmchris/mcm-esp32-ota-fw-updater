name: Actualizador Autom谩tico de Certificados

on:
  schedule:
    - cron: '0 8 * * 1' # Ejecutar todos los lunes a las 8 AM (o diario si prefieres)
  workflow_dispatch:    # Bot贸n manual para forzar la actualizaci贸n

jobs:
  update-certs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout del c贸digo
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Instalar dependencias
        run: |
          sudo apt-get update
          sudo apt-get install -y ca-certificates openssl
          pip install click pyopenssl certifi

      - name: Descargar herramientas
        run: |
          wget https://raw.githubusercontent.com/OPEnSLab-OSU/SSLClient/master/tools/pycert_bearssl/pycert_bearssl.py
          wget https://raw.githubusercontent.com/OPEnSLab-OSU/SSLClient/master/tools/pycert_bearssl/cert_util.py

      - name: Generar nuevos certificados (MCM_CertStore.h)
        run: |
          echo "Obteniendo certificados RAW desde crt.sh..."

          # 1. AAA Certificate Services (Legacy Sectigo)
          # Descarga directa del archivo .crt (binary/PEM)
          wget -O aaa_services.crt "https://crt.sh/?d=331986"

          # 2. Starfield Class 2 Certification Authority (Legacy AWS)
          # Usamos crt.sh ID 1063596 que corresponde al Root original de Starfield Class 2
          wget -O starfield_class2.crt "https://crt.sh/?d=1063596"

          echo "Generando Trust Anchors combinados..."
          
          # El script procesar谩:
          # - api.github.com (En vivo, USERTrust ECC)
          # - aaa_services.crt (Local, AAA)
          # - starfield_class2.crt (Local, Starfield)
          
          python3 pycert_bearssl.py download \
            api.github.com \
            aaa_services.crt \
            starfield_class2.crt \
            --output MCM_CertStore.h
            
          # LIMPIEZA
          rm *.crt *.py
          rm -rf __pycache__

      - name: Verificar cambios
        id: verify_diff
        run: |
          git diff MCM_CertStore.h

      - name: Crear Pull Request con los nuevos certificados
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "security: Actualizaci贸n de Certificados (GitHub + Legacy CDN)"
          title: " Actualizaci贸n de Certificados SSL (MCM_CertStore.h)"
          body: |
            Actualizaci贸n de Trust Anchors generada autom谩ticamente.
            
            **Contenido:**
            1. `api.github.com` (Escaneado en vivo).
            2. `AAA Certificate Services` (Inyectado para compatibilidad CDN).
            3. `Starfield Class 2` (Inyectado para compatibilidad AWS S3 Legacy).
          branch: update-ssl-certs
          base: main
          delete-branch: true
          add-paths: |
            MCM_CertStore.h