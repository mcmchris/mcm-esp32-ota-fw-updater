name: Actualizador Autom치tico de Certificados

on:
  schedule:
    - cron: '0 8 * * 1' # Ejecutar todos los lunes a las 8 AM (o diario si prefieres)
  workflow_dispatch:    # Bot칩n manual para forzar la actualizaci칩n

jobs:
  update-certs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout del c칩digo
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Instalar dependencias
        run: |
          sudo apt-get update
          sudo apt-get install -y ca-certificates openssl
          pip install click pyopenssl certifi

      - name: Descargar herramientas
        run: |
          wget https://raw.githubusercontent.com/OPEnSLab-OSU/SSLClient/master/tools/pycert_bearssl/pycert_bearssl.py
          wget https://raw.githubusercontent.com/OPEnSLab-OSU/SSLClient/master/tools/pycert_bearssl/cert_util.py

      - name: Generar nuevos certificados (MCM_CertStore.h)
        run: |
          echo "Obteniendo certificados exactos..."

          # 1. Descargamos 'AAA Certificate Services' (Ra칤z Legacy de Comodo/Sectigo)
          # Fuente: Repositorio oficial de Comodo/Sectigo v칤a crt.sh (ID 331986)
          wget -O aaa_services.crt "https://crt.sh/?d=331986"

          # 2. Descargamos 'Starfield Class 2' (Ra칤z Legacy de AWS/GoDaddy)
          # Fuente: Repositorio oficial de GoDaddy
          wget -O starfield_class2.crt "https://certs.godaddy.com/repository/sf_class2_root.crt"

          echo "Generando Trust Anchors combinados..."
          
          # COMANDO MAGISTRAL:
          # - api.github.com: Lo escaneamos en vivo para tener el ECC actual.
          # - *.crt: Le pasamos los archivos locales para forzar los Legacy.
          
          python3 pycert_bearssl.py download \
            api.github.com \
            aaa_services.crt \
            starfield_class2.crt \
            --output MCM_CertStore.h
            
          # LIMPIEZA
          rm *.crt *.py
          rm -rf __pycache__
            
          # Movemos el archivo generado a la ubicaci칩n correcta (ajusta si tu .h est치 en una carpeta 'src' o 'include')
          # mv MCM_CertStore.h src/MCM_CertStore.h  <-- DESCOMENTAR Y AJUSTAR SI ES NECESARIO

      - name: Verificar cambios
        id: verify_diff
        run: |
          git diff MCM_CertStore.h
          # Si no hay cambios, el paso siguiente no crear치 PR

      - name: Crear Pull Request con los nuevos certificados
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "security: Actualizaci칩n autom치tica de Certificados SSL"
          title: "游댏 Actualizaci칩n de Certificados SSL (MCM_CertStore.h)"
          body: |
            Este PR fue generado autom치ticamente por GitHub Actions.
            
            Se han detectado cambios en la cadena de certificaci칩n de GitHub.
            El archivo `MCM_CertStore.h` ha sido regenerado con los Trust Anchors vigentes hoy.
            
            **Pasos para el humano:**
            1. Revisa los cambios en el archivo.
            2. Si todo parece correcto (ves DigiCert, Sectigo, etc.), haz Merge.
            3. El sistema compilar치 el nuevo firmware autom치ticamente (si tienes CI de compilaci칩n).
          branch: update-ssl-certs
          base: main
          delete-branch: true

          add-paths: |
            MCM_CertStore.h