name: Actualizador Autom谩tico de Certificados

on:
  schedule:
    - cron: '0 8 * * 1' # Ejecutar todos los lunes a las 8 AM (o diario si prefieres)
  workflow_dispatch:    # Bot贸n manual para forzar la actualizaci贸n

jobs:
  update-certs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout del c贸digo
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Instalar dependencias del sistema
        run: |
          sudo apt-get update
          sudo apt-get install -y ca-certificates openssl

      - name: Instalar dependencias de Python
        run: |
          pip install click pyopenssl certifi

      - name: Descargar herramientas
        run: |
          wget https://raw.githubusercontent.com/OPEnSLab-OSU/SSLClient/master/tools/pycert_bearssl/pycert_bearssl.py
          wget https://raw.githubusercontent.com/OPEnSLab-OSU/SSLClient/master/tools/pycert_bearssl/cert_util.py

      - name: Generar nuevos certificados (MCM_CertStore.h)
        run: |
          echo "Generando Trust Anchors..."
          
          # ESTRATEGIA DE "DOMINIOS ANCLA":
          # 1. api.github.com -> El real que usa GitHub hoy.
          # 2. sectigo.com -> Forza la inclusi贸n de 'USERTrust' y 'AAA' (Sectigo/Comodo).
          # 3. aws.amazon.com -> Forza la inclusi贸n de 'Starfield' (AWS), m谩s estable que escanear s3.
          
          python3 pycert_bearssl.py download \
            api.github.com \
            sectigo.com \
            aws.amazon.com \
            --output MCM_CertStore.h
            
          # LIMPIEZA
          rm pycert_bearssl.py cert_util.py
          rm -rf __pycache__
            
          # Movemos el archivo generado a la ubicaci贸n correcta (ajusta si tu .h est谩 en una carpeta 'src' o 'include')
          # mv MCM_CertStore.h src/MCM_CertStore.h  <-- DESCOMENTAR Y AJUSTAR SI ES NECESARIO

      - name: Verificar cambios
        id: verify_diff
        run: |
          git diff MCM_CertStore.h
          # Si no hay cambios, el paso siguiente no crear谩 PR

      - name: Crear Pull Request con los nuevos certificados
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "security: Actualizaci贸n autom谩tica de Certificados SSL"
          title: " Actualizaci贸n de Certificados SSL (MCM_CertStore.h)"
          body: |
            Este PR fue generado autom谩ticamente por GitHub Actions.
            
            Se han detectado cambios en la cadena de certificaci贸n de GitHub.
            El archivo `MCM_CertStore.h` ha sido regenerado con los Trust Anchors vigentes hoy.
            
            **Pasos para el humano:**
            1. Revisa los cambios en el archivo.
            2. Si todo parece correcto (ves DigiCert, Sectigo, etc.), haz Merge.
            3. El sistema compilar谩 el nuevo firmware autom谩ticamente (si tienes CI de compilaci贸n).
          branch: update-ssl-certs
          base: main
          delete-branch: true

          add-paths: |
            MCM_CertStore.h