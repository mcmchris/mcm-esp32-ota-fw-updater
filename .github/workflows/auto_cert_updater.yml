name: Actualizador Automático de Certificados

on:
  schedule:
    - cron: '0 8 * * 1' # Ejecutar todos los lunes a las 8 AM (o diario si prefieres)
  workflow_dispatch:    # Botón manual para forzar la actualización

jobs:
  update-certs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Instalar dependencias del sistema
        run: |
          sudo apt-get update
          sudo apt-get install -y ca-certificates openssl

      - name: Instalar dependencias de Python
        run: |
          pip install click pyopenssl certifi

      - name: Descargar herramientas
        run: |
          wget https://raw.githubusercontent.com/OPEnSLab-OSU/SSLClient/master/tools/pycert_bearssl/pycert_bearssl.py
          wget https://raw.githubusercontent.com/OPEnSLab-OSU/SSLClient/master/tools/pycert_bearssl/cert_util.py

      - name: Generar nuevos certificados (MCM_CertStore.h)
        run: |
          echo "Generando Trust Anchors..."
          
          # ESTRATEGIA DE "DOMINIOS ANCLA":
          # 1. api.github.com -> El real que usa GitHub hoy.
          # 2. sectigo.com -> Forza la inclusión de 'USERTrust' y 'AAA' (Sectigo/Comodo).
          # 3. aws.amazon.com -> Forza la inclusión de 'Starfield' (AWS), más estable que escanear s3.
          
          python3 pycert_bearssl.py download \
            api.github.com \
            sectigo.com \
            aws.amazon.com \
            --output MCM_CertStore.h
            
          # LIMPIEZA
          rm pycert_bearssl.py cert_util.py
          rm -rf __pycache__