name: Actualizador Automático de Certificados

on:
  schedule:
    - cron: '0 8 * * 1' # Ejecutar todos los lunes a las 8 AM (o diario si prefieres)
  workflow_dispatch:    # Botón manual para forzar la actualización

jobs:
  update-certs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Instalar dependencias del script
        run: |
          pip install click pyopenssl certifi

      - name: Descargar herramienta (pycert_bearssl + dependencias)
        run: |
          # Descargamos el script oficial de la librería SSLClient
          wget https://raw.githubusercontent.com/OPEnSLab-OSU/SSLClient/master/tools/pycert_bearssl/pycert_bearssl.py
          wget https://raw.githubusercontent.com/OPEnSLab-OSU/SSLClient/master/tools/pycert_bearssl/cert_util.py

      - name: Generar nuevos certificados (MCM_CertStore.h)
        run: |
          echo "Generando Trust Anchors para GitHub y AWS (S3)..."
          
          # Ejecutamos el script contra los dominios críticos:
          # 1. api.github.com -> Para la API REST
          
          python3 pycert_bearssl.py download \
            api.github.com \
            s3.amazonaws.com \
            codeload.github.com \
            --output MCM_CertStore.h
          
          rm pycert_bearssl.py cert_util.py
          rm -rf __pycache__
            
          # Movemos el archivo generado a la ubicación correcta (ajusta si tu .h está en una carpeta 'src' o 'include')
          # mv MCM_CertStore.h src/MCM_CertStore.h  <-- DESCOMENTAR Y AJUSTAR SI ES NECESARIO

      - name: Verificar cambios
        id: verify_diff
        run: |
          git diff MCM_CertStore.h
          # Si no hay cambios, el paso siguiente no creará PR

