name: OTA Certificates Monitor

on:
  schedule:
    - cron: '0 8 * * *' # Run everyday at 8 AM UTC
  workflow_dispatch:    # Manual trigger enabled

jobs:
  check-certs:
    runs-on: ubuntu-latest
    steps:
      - name: Verify Certificate Chain (API and CDN)
        run: |
          # Function to verify a domain
          check_domain() {
            local domain=$1
            echo "------------------------------------------------"
            echo "üîç Verifying domain: $domain"
            
            # Get the Issuer (who signs the certificate)
            # We use -connect with timeout to avoid blocks
            local issuer=$(echo | openssl s_client -servername $domain -connect $domain:443 2>/dev/null | openssl x509 -noout -issuer)
            
            if [ -z "$issuer" ]; then
              echo "::error::‚ùå Connection error or failed SSL handshake with $domain"
              return 1
            fi
            
            echo "   üìÑ Detected issuer: $issuer"
            
            # WHITELIST OF KNOWN ISSUERS
            # DigiCert: Traditionally used by GitHub
            # Sectigo / USERTrust: Currently used in the API
            # Entrust / Starfield: Sometimes used in CDNs
            
            if [[ "$issuer" == *"DigiCert"* ]] || \
               [[ "$issuer" == *"Sectigo"* ]] || \
               [[ "$issuer" == *"USERTrust"* ]] || \
               [[ "$issuer" == *"Starfield"* ]]; then
               
              echo "   ‚úÖ Certificate OK (Valid trust)."
            else
              echo "::error::üö® ALERT! The certificate for $domain has changed to an unknown issuer!"
              echo "   New Issuer: $issuer"
              return 1
            fi
          }

          # 1. Verify the API (Controls the JSON version query)
          check_domain "api.github.com" || exit 1
          
          # 2. Verify the CDN (Controls the .bin download)
          # This is vital because this is where they usually use old certificates or rotate to Azure/AWS
          check_domain "raw.githubusercontent.com" || exit 1
          
          echo "------------------------------------------------"
          echo "üéâ Everything seems in order. Your Trust Anchors should continue working."