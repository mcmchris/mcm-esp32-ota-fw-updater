name: Monitor de Certificados OTA

on:
  schedule:
    - cron: '0 8 * * *' # Ejecutar todos los d√≠as a las 8 AM UTC
  workflow_dispatch:    # Bot√≥n manual para probarlo ya mismo

jobs:
  check-certs:
    runs-on: ubuntu-latest
    steps:
      - name: Verificar Cadena de Certificados (API y CDN)
        run: |
          # Funci√≥n para verificar un dominio
          check_domain() {
            local domain=$1
            echo "------------------------------------------------"
            echo "üîç Verificando dominio: $domain"
            
            # Obtener el Issuer (quien firma el certificado)
            # Usamos -connect con timeout para evitar bloqueos
            local issuer=$(echo | openssl s_client -servername $domain -connect $domain:443 2>/dev/null | openssl x509 -noout -issuer)
            
            if [ -z "$issuer" ]; then
              echo "::error::‚ùå Error de conexi√≥n o SSL handshake fallido con $domain"
              return 1
            fi
            
            echo "   üìÑ Emisor detectado: $issuer"
            
            # LISTA BLANCA DE EMISORES CONOCIDOS
            # DigiCert: Usado tradicionalmente por GitHub
            # Sectigo / USERTrust: Usado actualmente en la API
            # Entrust / Starfield: A veces usado en CDNs
            
            if [[ "$issuer" == *"DigiCert"* ]] || \
               [[ "$issuer" == *"Sectigo"* ]] || \
               [[ "$issuer" == *"USERTrust"* ]] || \
               [[ "$issuer" == *"Starfield"* ]]; then
               
              echo "   ‚úÖ Certificado OK (Confianza v√°lida)."
            else
              echo "::error::üö® ¬°ALERTA! El certificado de $domain ha cambiado a un emisor desconocido!"
              echo "   Nuevo Emisor: $issuer"
              return 1
            fi
          }

          # 1. Verificar la API (Controla la consulta de versi√≥n JSON)
          check_domain "api.github.com" || exit 1
          
          # 2. Verificar el CDN (Controla la descarga del .bin)
          # Esto es vital porque aqu√≠ es donde suelen usar certificados viejos o rotar a Azure/AWS
          check_domain "raw.githubusercontent.com" || exit 1
          
          echo "------------------------------------------------"
          echo "üéâ Todo parece en orden. Tus Trust Anchors deber√≠an seguir funcionando."